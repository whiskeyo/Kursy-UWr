/*
 * row-major vs. tiled texture queries
 *
 * Intel® Core™ i5-6600 CPU @ 3.30GHz
 *
 * $ ./texture -S 0xdeadc0de -t 65536 -v 0
 * Time elapsed: 1.707234 seconds.
 * $ ./texture -S 0xdeadc0de -t 65536 -v 1
 * Time elapsed: 1.031514 seconds.
 * $ ./texture -S 0xdeadc0de -t 65536 -v 2
 * Time elapsed: 0.935953 seconds.
 */
#include "texture.h"

static inline long index_0(long x, long y)
{
    return y * N + x;
}

#define VARIANT 0
#include "texture_impl.h"

static inline long index_1(long x, long y)
{
    /*
    // index1slow
    // ten sposob ma duza lokalnosc czasowa, jednak
    // dziala zbyt wolno (okolo 1.5x dluzej)
    static const uint64_t masks[6] = {
        0x5555555555555555,
        0x3333333333333333,
        0x0F0F0F0F0F0F0F0F,
        0x00FF00FF00FF00FF,
        0x0000FFFF0000FFFF,
        0x00000000FFFFFFFF
    };
    static const uint64_t shifts[6] = { 
        1, 2, 4, 8, 16, 32 
    };

    //x = (x | (x << shifts[5])) & masks[5];
    //x = (x | (x << shifts[4])) & masks[4];
    x = (x | (x << shifts[3])) & masks[3];
    x = (x | (x << shifts[2])) & masks[2];
    x = (x | (x << shifts[1])) & masks[1];
    x = (x | (x << shifts[0])) & masks[0];

    //y = (y | (y << shifts[5])) & masks[5];
    //y = (y | (y << shifts[4])) & masks[4];
    y = (y | (y << shifts[3])) & masks[3];
    y = (y | (y << shifts[2])) & masks[2];
    y = (y | (y << shifts[1])) & masks[1];
    y = (y | (y << shifts[0])) & masks[0];

    const long result = x | (y << 1);
    return result;
    */

    // index1fast
    static const unsigned short MortonTable256X[256] = {
        0x0000, 0x0001, 0x0004, 0x0005, 0x0010, 0x0011, 0x0014, 0x0015, 0x0040, 0x0041, 0x0044, 0x0045, 0x0050, 0x0051, 0x0054, 0x0055, 
        0x0100, 0x0101, 0x0104, 0x0105, 0x0110, 0x0111, 0x0114, 0x0115, 0x0140, 0x0141, 0x0144, 0x0145, 0x0150, 0x0151, 0x0154, 0x0155, 
        0x0400, 0x0401, 0x0404, 0x0405, 0x0410, 0x0411, 0x0414, 0x0415, 0x0440, 0x0441, 0x0444, 0x0445, 0x0450, 0x0451, 0x0454, 0x0455, 
        0x0500, 0x0501, 0x0504, 0x0505, 0x0510, 0x0511, 0x0514, 0x0515, 0x0540, 0x0541, 0x0544, 0x0545, 0x0550, 0x0551, 0x0554, 0x0555, 
        0x1000, 0x1001, 0x1004, 0x1005, 0x1010, 0x1011, 0x1014, 0x1015, 0x1040, 0x1041, 0x1044, 0x1045, 0x1050, 0x1051, 0x1054, 0x1055, 
        0x1100, 0x1101, 0x1104, 0x1105, 0x1110, 0x1111, 0x1114, 0x1115, 0x1140, 0x1141, 0x1144, 0x1145, 0x1150, 0x1151, 0x1154, 0x1155, 
        0x1400, 0x1401, 0x1404, 0x1405, 0x1410, 0x1411, 0x1414, 0x1415, 0x1440, 0x1441, 0x1444, 0x1445, 0x1450, 0x1451, 0x1454, 0x1455, 
        0x1500, 0x1501, 0x1504, 0x1505, 0x1510, 0x1511, 0x1514, 0x1515, 0x1540, 0x1541, 0x1544, 0x1545, 0x1550, 0x1551, 0x1554, 0x1555, 
        0x4000, 0x4001, 0x4004, 0x4005, 0x4010, 0x4011, 0x4014, 0x4015, 0x4040, 0x4041, 0x4044, 0x4045, 0x4050, 0x4051, 0x4054, 0x4055, 
        0x4100, 0x4101, 0x4104, 0x4105, 0x4110, 0x4111, 0x4114, 0x4115, 0x4140, 0x4141, 0x4144, 0x4145, 0x4150, 0x4151, 0x4154, 0x4155, 
        0x4400, 0x4401, 0x4404, 0x4405, 0x4410, 0x4411, 0x4414, 0x4415, 0x4440, 0x4441, 0x4444, 0x4445, 0x4450, 0x4451, 0x4454, 0x4455, 
        0x4500, 0x4501, 0x4504, 0x4505, 0x4510, 0x4511, 0x4514, 0x4515, 0x4540, 0x4541, 0x4544, 0x4545, 0x4550, 0x4551, 0x4554, 0x4555, 
        0x5000, 0x5001, 0x5004, 0x5005, 0x5010, 0x5011, 0x5014, 0x5015, 0x5040, 0x5041, 0x5044, 0x5045, 0x5050, 0x5051, 0x5054, 0x5055, 
        0x5100, 0x5101, 0x5104, 0x5105, 0x5110, 0x5111, 0x5114, 0x5115, 0x5140, 0x5141, 0x5144, 0x5145, 0x5150, 0x5151, 0x5154, 0x5155, 
        0x5400, 0x5401, 0x5404, 0x5405, 0x5410, 0x5411, 0x5414, 0x5415, 0x5440, 0x5441, 0x5444, 0x5445, 0x5450, 0x5451, 0x5454, 0x5455, 
        0x5500, 0x5501, 0x5504, 0x5505, 0x5510, 0x5511, 0x5514, 0x5515, 0x5540, 0x5541, 0x5544, 0x5545, 0x5550, 0x5551, 0x5554, 0x5555
    };

    static const unsigned short MortonTable256Y[256] = {                                                                                                                            
        0x0000, 0x0002, 0x0008, 0x000a, 0x0020, 0x0022, 0x0028, 0x002a, 0x0080, 0x0082, 0x0088, 0x008a, 0x00a0, 0x00a2, 0x00a8, 0x00aa, 
        0x0200, 0x0202, 0x0208, 0x020a, 0x0220, 0x0222, 0x0228, 0x022a, 0x0280, 0x0282, 0x0288, 0x028a, 0x02a0, 0x02a2, 0x02a8, 0x02aa,
        0x0800, 0x0802, 0x0808, 0x080a, 0x0820, 0x0822, 0x0828, 0x082a, 0x0880, 0x0882, 0x0888, 0x088a, 0x08a0, 0x08a2, 0x08a8, 0x08aa, 
        0x0a00, 0x0a02, 0x0a08, 0x0a0a, 0x0a20, 0x0a22, 0x0a28, 0x0a2a, 0x0a80, 0x0a82, 0x0a88, 0x0a8a, 0x0aa0, 0x0aa2, 0x0aa8, 0x0aaa, 
        0x2000, 0x2002, 0x2008, 0x200a, 0x2020, 0x2022, 0x2028, 0x202a, 0x2080, 0x2082, 0x2088, 0x208a, 0x20a0, 0x20a2, 0x20a8, 0x20aa, 
        0x2200, 0x2202, 0x2208, 0x220a, 0x2220, 0x2222, 0x2228, 0x222a, 0x2280, 0x2282, 0x2288, 0x228a, 0x22a0, 0x22a2, 0x22a8, 0x22aa, 
        0x2800, 0x2802, 0x2808, 0x280a, 0x2820, 0x2822, 0x2828, 0x282a, 0x2880, 0x2882, 0x2888, 0x288a, 0x28a0, 0x28a2, 0x28a8, 0x28aa,
        0x2a00, 0x2a02, 0x2a08, 0x2a0a, 0x2a20, 0x2a22, 0x2a28, 0x2a2a, 0x2a80, 0x2a82, 0x2a88, 0x2a8a, 0x2aa0, 0x2aa2, 0x2aa8, 0x2aaa, 
        0x8000, 0x8002, 0x8008, 0x800a, 0x8020, 0x8022, 0x8028, 0x802a, 0x8080, 0x8082, 0x8088, 0x808a, 0x80a0, 0x80a2, 0x80a8, 0x80aa, 
        0x8200, 0x8202, 0x8208, 0x820a, 0x8220, 0x8222, 0x8228, 0x822a, 0x8280, 0x8282, 0x8288, 0x828a, 0x82a0, 0x82a2, 0x82a8, 0x82aa, 
        0x8800, 0x8802, 0x8808, 0x880a, 0x8820, 0x8822, 0x8828, 0x882a, 0x8880, 0x8882, 0x8888, 0x888a, 0x88a0, 0x88a2, 0x88a8, 0x88aa, 
        0x8a00, 0x8a02, 0x8a08, 0x8a0a, 0x8a20, 0x8a22, 0x8a28, 0x8a2a, 0x8a80, 0x8a82, 0x8a88, 0x8a8a, 0x8aa0, 0x8aa2, 0x8aa8, 0x8aaa, 
        0xa000, 0xa002, 0xa008, 0xa00a, 0xa020, 0xa022, 0xa028, 0xa02a, 0xa080, 0xa082, 0xa088, 0xa08a, 0xa0a0, 0xa0a2, 0xa0a8, 0xa0aa, 
        0xa200, 0xa202, 0xa208, 0xa20a, 0xa220, 0xa222, 0xa228, 0xa22a, 0xa280, 0xa282, 0xa288, 0xa28a, 0xa2a0, 0xa2a2, 0xa2a8, 0xa2aa, 
        0xa800, 0xa802, 0xa808, 0xa80a, 0xa820, 0xa822, 0xa828, 0xa82a, 0xa880, 0xa882, 0xa888, 0xa88a, 0xa8a0, 0xa8a2, 0xa8a8, 0xa8aa, 
        0xaa00, 0xaa02, 0xaa08, 0xaa0a, 0xaa20, 0xaa22, 0xaa28, 0xaa2a, 0xaa80, 0xaa82, 0xaa88, 0xaa8a, 0xaaa0, 0xaaa2, 0xaaa8, 0xaaaa 
    };

    static unsigned int MortonTable256X16[256] = {
        0000000000, 0x00010000, 0x00040000, 0x00050000, 0x00100000, 0x00110000, 0x00140000, 0x00150000, 0x00400000, 0x00410000, 0x00440000, 0x00450000, 0x00500000, 0x00510000, 0x00540000, 0x00550000, 
        0x01000000, 0x01010000, 0x01040000, 0x01050000, 0x01100000, 0x01110000, 0x01140000, 0x01150000, 0x01400000, 0x01410000, 0x01440000, 0x01450000, 0x01500000, 0x01510000, 0x01540000, 0x01550000, 
        0x04000000, 0x04010000, 0x04040000, 0x04050000, 0x04100000, 0x04110000, 0x04140000, 0x04150000, 0x04400000, 0x04410000, 0x04440000, 0x04450000, 0x04500000, 0x04510000, 0x04540000, 0x04550000, 
        0x05000000, 0x05010000, 0x05040000, 0x05050000, 0x05100000, 0x05110000, 0x05140000, 0x05150000, 0x05400000, 0x05410000, 0x05440000, 0x05450000, 0x05500000, 0x05510000, 0x05540000, 0x05550000, 
        0x10000000, 0x10010000, 0x10040000, 0x10050000, 0x10100000, 0x10110000, 0x10140000, 0x10150000, 0x10400000, 0x10410000, 0x10440000, 0x10450000, 0x10500000, 0x10510000, 0x10540000, 0x10550000, 
        0x11000000, 0x11010000, 0x11040000, 0x11050000, 0x11100000, 0x11110000, 0x11140000, 0x11150000, 0x11400000, 0x11410000, 0x11440000, 0x11450000, 0x11500000, 0x11510000, 0x11540000, 0x11550000, 
        0x14000000, 0x14010000, 0x14040000, 0x14050000, 0x14100000, 0x14110000, 0x14140000, 0x14150000, 0x14400000, 0x14410000, 0x14440000, 0x14450000, 0x14500000, 0x14510000, 0x14540000, 0x14550000, 
        0x15000000, 0x15010000, 0x15040000, 0x15050000, 0x15100000, 0x15110000, 0x15140000, 0x15150000, 0x15400000, 0x15410000, 0x15440000, 0x15450000, 0x15500000, 0x15510000, 0x15540000, 0x15550000, 
        0x40000000, 0x40010000, 0x40040000, 0x40050000, 0x40100000, 0x40110000, 0x40140000, 0x40150000, 0x40400000, 0x40410000, 0x40440000, 0x40450000, 0x40500000, 0x40510000, 0x40540000, 0x40550000, 
        0x41000000, 0x41010000, 0x41040000, 0x41050000, 0x41100000, 0x41110000, 0x41140000, 0x41150000, 0x41400000, 0x41410000, 0x41440000, 0x41450000, 0x41500000, 0x41510000, 0x41540000, 0x41550000, 
        0x44000000, 0x44010000, 0x44040000, 0x44050000, 0x44100000, 0x44110000, 0x44140000, 0x44150000, 0x44400000, 0x44410000, 0x44440000, 0x44450000, 0x44500000, 0x44510000, 0x44540000, 0x44550000, 
        0x45000000, 0x45010000, 0x45040000, 0x45050000, 0x45100000, 0x45110000, 0x45140000, 0x45150000, 0x45400000, 0x45410000, 0x45440000, 0x45450000, 0x45500000, 0x45510000, 0x45540000, 0x45550000, 
        0x50000000, 0x50010000, 0x50040000, 0x50050000, 0x50100000, 0x50110000, 0x50140000, 0x50150000, 0x50400000, 0x50410000, 0x50440000, 0x50450000, 0x50500000, 0x50510000, 0x50540000, 0x50550000, 
        0x51000000, 0x51010000, 0x51040000, 0x51050000, 0x51100000, 0x51110000, 0x51140000, 0x51150000, 0x51400000, 0x51410000, 0x51440000, 0x51450000, 0x51500000, 0x51510000, 0x51540000, 0x51550000, 
        0x54000000, 0x54010000, 0x54040000, 0x54050000, 0x54100000, 0x54110000, 0x54140000, 0x54150000, 0x54400000, 0x54410000, 0x54440000, 0x54450000, 0x54500000, 0x54510000, 0x54540000, 0x54550000, 
        0x55000000, 0x55010000, 0x55040000, 0x55050000, 0x55100000, 0x55110000, 0x55140000, 0x55150000, 0x55400000, 0x55410000, 0x55440000, 0x55450000, 0x55500000, 0x55510000, 0x55540000, 0x55550000 
    };


    static unsigned int MortonTable256Y16[256] = {
        0000000000, 0x00020000, 0x00080000, 0x000a0000, 0x00200000, 0x00220000, 0x00280000, 0x002a0000, 0x00800000, 0x00820000, 0x00880000, 0x008a0000, 0x00a00000, 0x00a20000, 0x00a80000, 0x00aa0000, 
        0x02000000, 0x02020000, 0x02080000, 0x020a0000, 0x02200000, 0x02220000, 0x02280000, 0x022a0000, 0x02800000, 0x02820000, 0x02880000, 0x028a0000, 0x02a00000, 0x02a20000, 0x02a80000, 0x02aa0000, 
        0x08000000, 0x08020000, 0x08080000, 0x080a0000, 0x08200000, 0x08220000, 0x08280000, 0x082a0000, 0x08800000, 0x08820000, 0x08880000, 0x088a0000, 0x08a00000, 0x08a20000, 0x08a80000, 0x08aa0000, 
        0x0a000000, 0x0a020000, 0x0a080000, 0x0a0a0000, 0x0a200000, 0x0a220000, 0x0a280000, 0x0a2a0000, 0x0a800000, 0x0a820000, 0x0a880000, 0x0a8a0000, 0x0aa00000, 0x0aa20000, 0x0aa80000, 0x0aaa0000, 
        0x20000000, 0x20020000, 0x20080000, 0x200a0000, 0x20200000, 0x20220000, 0x20280000, 0x202a0000, 0x20800000, 0x20820000, 0x20880000, 0x208a0000, 0x20a00000, 0x20a20000, 0x20a80000, 0x20aa0000, 
        0x22000000, 0x22020000, 0x22080000, 0x220a0000, 0x22200000, 0x22220000, 0x22280000, 0x222a0000, 0x22800000, 0x22820000, 0x22880000, 0x228a0000, 0x22a00000, 0x22a20000, 0x22a80000, 0x22aa0000, 
        0x28000000, 0x28020000, 0x28080000, 0x280a0000, 0x28200000, 0x28220000, 0x28280000, 0x282a0000, 0x28800000, 0x28820000, 0x28880000, 0x288a0000, 0x28a00000, 0x28a20000, 0x28a80000, 0x28aa0000, 
        0x2a000000, 0x2a020000, 0x2a080000, 0x2a0a0000, 0x2a200000, 0x2a220000, 0x2a280000, 0x2a2a0000, 0x2a800000, 0x2a820000, 0x2a880000, 0x2a8a0000, 0x2aa00000, 0x2aa20000, 0x2aa80000, 0x2aaa0000, 
        0x80000000, 0x80020000, 0x80080000, 0x800a0000, 0x80200000, 0x80220000, 0x80280000, 0x802a0000, 0x80800000, 0x80820000, 0x80880000, 0x808a0000, 0x80a00000, 0x80a20000, 0x80a80000, 0x80aa0000, 
        0x82000000, 0x82020000, 0x82080000, 0x820a0000, 0x82200000, 0x82220000, 0x82280000, 0x822a0000, 0x82800000, 0x82820000, 0x82880000, 0x828a0000, 0x82a00000, 0x82a20000, 0x82a80000, 0x82aa0000, 
        0x88000000, 0x88020000, 0x88080000, 0x880a0000, 0x88200000, 0x88220000, 0x88280000, 0x882a0000, 0x88800000, 0x88820000, 0x88880000, 0x888a0000, 0x88a00000, 0x88a20000, 0x88a80000, 0x88aa0000, 
        0x8a000000, 0x8a020000, 0x8a080000, 0x8a0a0000, 0x8a200000, 0x8a220000, 0x8a280000, 0x8a2a0000, 0x8a800000, 0x8a820000, 0x8a880000, 0x8a8a0000, 0x8aa00000, 0x8aa20000, 0x8aa80000, 0x8aaa0000, 
        0xa0000000, 0xa0020000, 0xa0080000, 0xa00a0000, 0xa0200000, 0xa0220000, 0xa0280000, 0xa02a0000, 0xa0800000, 0xa0820000, 0xa0880000, 0xa08a0000, 0xa0a00000, 0xa0a20000, 0xa0a80000, 0xa0aa0000, 
        0xa2000000, 0xa2020000, 0xa2080000, 0xa20a0000, 0xa2200000, 0xa2220000, 0xa2280000, 0xa22a0000, 0xa2800000, 0xa2820000, 0xa2880000, 0xa28a0000, 0xa2a00000, 0xa2a20000, 0xa2a80000, 0xa2aa0000, 
        0xa8000000, 0xa8020000, 0xa8080000, 0xa80a0000, 0xa8200000, 0xa8220000, 0xa8280000, 0xa82a0000, 0xa8800000, 0xa8820000, 0xa8880000, 0xa88a0000, 0xa8a00000, 0xa8a20000, 0xa8a80000, 0xa8aa0000, 
        0xaa000000, 0xaa020000, 0xaa080000, 0xaa0a0000, 0xaa200000, 0xaa220000, 0xaa280000, 0xaa2a0000, 0xaa800000, 0xaa820000, 0xaa880000, 0xaa8a0000, 0xaaa00000, 0xaaa20000, 0xaaa80000, 0xaaaa0000
    };

    return MortonTable256Y16[y >> 8] | MortonTable256X16[x >> 8] | MortonTable256Y[y & 0xFF] | MortonTable256X[x & 0xFF];
}

#define VARIANT 1
#include "texture_impl.h"
